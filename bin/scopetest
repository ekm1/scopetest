#!/usr/bin/env node

const { execFileSync } = require('child_process');
const path = require('path');
const fs = require('fs');

const PLATFORMS = {
  'darwin-arm64': '@scopetest/darwin-arm64',
  'darwin-x64': '@scopetest/darwin-x64',
  'linux-x64': '@scopetest/linux-x64-gnu',
  'linux-arm64': '@scopetest/linux-arm64-gnu',
  'win32-x64': '@scopetest/win32-x64-msvc',
};

function getBinaryPath() {
  const platform = process.platform;
  const arch = process.arch;
  const key = `${platform}-${arch}`;
  const pkg = PLATFORMS[key];

  if (!pkg) {
    console.error(`Unsupported platform: ${platform}-${arch}`);
    process.exit(1);
  }

  try {
    const ext = platform === 'win32' ? '.exe' : '';
    return require.resolve(`${pkg}/scopetest${ext}`);
  } catch {
    console.error(`Binary not found for ${platform}-${arch}`);
    console.error('Try reinstalling: npm install -g scopetest');
    process.exit(1);
  }
}

const binary = getBinaryPath();
const args = process.argv.slice(2);

try {
  execFileSync(binary, args, { stdio: 'inherit' });
} catch (err) {
  process.exit(err.status || 1);
}
