#!/usr/bin/env node

const { execFileSync } = require('child_process');
const path = require('path');
const fs = require('fs');

const BINARIES = {
  'darwin-arm64': 'scopetest-darwin-arm64',
  'darwin-x64': 'scopetest-darwin-x64',
  'linux-x64': 'scopetest-linux-x64',
  'linux-arm64': 'scopetest-linux-arm64',
  'win32-x64': 'scopetest-win32-x64.exe',
};

function getBinaryPath() {
  const key = `${process.platform}-${process.arch}`;
  const binaryName = BINARIES[key];

  if (!binaryName) {
    console.error(`Unsupported platform: ${process.platform}-${process.arch}`);
    console.error('Supported: darwin-arm64, darwin-x64, linux-x64, linux-arm64, win32-x64');
    process.exit(1);
  }

  const binaryPath = path.join(__dirname, '..', 'binaries', binaryName);
  
  if (!fs.existsSync(binaryPath)) {
    console.error(`Binary not found: ${binaryPath}`);
    console.error('Try reinstalling: npm install scopetest');
    process.exit(1);
  }

  return binaryPath;
}

const binary = getBinaryPath();

try {
  execFileSync(binary, process.argv.slice(2), { stdio: 'inherit' });
} catch (err) {
  process.exit(err.status || 1);
}
